{% extends "base.html" %}
{% load static %}

{% block title %}Player Dashboard · Sports Portal{% endblock %}

{% block extra_head %}
<style>
  html, body { background:#f8fafc; }

  /* Avatars: fixed size to prevent layout shift */
  .avatar     { width:106px; height:106px; object-fit:cover; border-radius:50%; }
  .avatar-sm  { width:60px;  height:60px;  object-fit:cover; border-radius:50%; }

  /* Sticky left/right columns */
  .sticky-col { position:sticky; top:24px; }

  /* Scoreboard */
  .scoreboard-strip { background:linear-gradient(135deg,#0d6efd 0%,#20c997 100%); color:#fff; border-radius:.75rem; }
  .scoreboard-tile .label { opacity:.85; font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; }
  .scoreboard-number { font-size:clamp(1.5rem,3.2vw,2rem); font-weight:700; }

  /* Cards + tables polish */
  .card { border:0; }
  .table thead th { border-bottom-width:1px; text-transform:uppercase; font-size:.75rem; letter-spacing:.06em; }

  /* Photo grid with stable aspect ratio */
  .photo-wrap { position:relative; width:100%; aspect-ratio:4/3; overflow:hidden; border-top-left-radius:.5rem; border-top-right-radius:.5rem; background:#e9ecef; }
  .photo-wrap img { width:100%; height:100%; object-fit:cover; display:block; }

  /* Focus styles for keyboard users */
  .btn:focus-visible, a:focus-visible { outline:2px solid var(--bs-primary); outline-offset:2px; border-radius:.5rem; }

  /* Reduced motion respect */
  @media (prefers-reduced-motion: reduce) {
    .fade, .collapse, .collapsing { transition:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<main class="container" style="margin-top:24px; max-width:1400px;">
  <div class="row g-3">

    <!-- Left Column -->
    <aside class="col-lg-3">
      <div class="sticky-col">

        <!-- Profile card -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 text-center mb-3">My Profile</h2>
            <p class="text-center mb-2">
              {% if profile.photo %}
                <img src="{{ profile.photo.url }}"
                     class="avatar" alt="Avatar of {{ profile.full_name|default:request.user.username }}"
                     width="106" height="106"
                     onerror="this.onerror=null;this.src='{% static 'images/placeholders/avatar.png' %}'">
              {% elif request.user.avatar %}
                <img src="{{ request.user.avatar.url }}"
                     class="avatar" alt="Avatar of {{ profile.full_name|default:request.user.username }}"
                     width="106" height="106"
                     onerror="this.onerror=null;this.src='{% static 'images/placeholders/avatar.png' %}'">
              {% else %}
                <img src="{% static 'images/placeholders/avatar.png' %}"
                     class="avatar" alt="Default avatar"
                     width="106" height="106">
              {% endif %}
            </p>

            <div class="text-center fw-semibold">
              {{ profile.full_name|default:request.user.username }}
            </div>
            <div class="text-center small text-muted">{{ request.user.email }}</div>

            {% if request.user.sports.all %}
              <div class="text-center mt-2">
                {% for sp in request.user.sports.all %}
                  <span class="badge text-bg-secondary me-1 mb-1">{{ sp.name }}</span>
                {% empty %}
                {% endfor %}
              </div>
            {% endif %}

            <hr>
            <div class="d-grid gap-2">
              <a class="btn btn-outline-primary btn-sm" href="{% url 'players:profile_edit' %}">
                <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>Edit profile
              </a>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'players:gallery_upload' %}">
                <i class="bi bi-cloud-upload me-1" aria-hidden="true"></i>Upload photo
              </a>
            </div>
          </div>
        </div>

        <!-- Pending Invites -->
        {% if pending_invites %}
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h3 class="h6 mb-0">Team invites</h3>
              <span class="badge bg-primary">{{ pending_invites|length }}</span>
            </div>
            <ul class="list-group list-group-flush">
              {% for inv in pending_invites %}
              <li class="list-group-item d-flex align-items-center justify-content-between">
                <span class="small">{{ inv.team.name }} · {{ inv.team.sport.name }}</span>
                <form method="post" action="{% url 'players:team_accept' inv.team.id %}">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-success">Join</button>
                </form>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        {% endif %}

        <!-- Interests -->
        <div class="card shadow-sm mt-3 d-none d-md-block">
          <div class="card-body">
            <p class="mb-2 fw-semibold">Interests</p>
            {% if interests %}
              <div class="d-flex flex-wrap gap-2">
                {% for tag in interests %}
                  <span class="badge text-bg-secondary">{{ tag }}</span>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted small">Add interests from your profile to get better recommendations.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </aside>

    <!-- Middle Column -->
    <section class="col-lg-7">

      <!-- Scoreboard -->
      <div class="scoreboard-strip p-3 p-lg-4 shadow-sm mb-3">
        <div class="row g-3 g-lg-4 text-center">
          <div class="col-6 col-lg-3">
            <div class="scoreboard-tile">
              <div class="label">Registered athletes</div>
              <div class="scoreboard-number" aria-live="polite">{{ stats.athletes|default:0 }}</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="scoreboard-tile">
              <div class="label">Teams</div>
              <div class="scoreboard-number" aria-live="polite">{{ stats.teams|default:0 }}</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="scoreboard-tile">
              <div class="label">Matches scheduled</div>
              <div class="scoreboard-number" aria-live="polite">{{ stats.matches|default:0 }}</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="scoreboard-tile">
              <div class="label">Venues</div>
              <div class="scoreboard-number" aria-live="polite">{{ stats.venues|default:0 }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Teams you’re in -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h3 class="h5 mb-0">My teams</h3>
            <a href="{% url 'players:team_create' %}" class="btn btn-sm btn-primary">
              <i class="bi bi-people me-1" aria-hidden="true"></i>Create team
            </a>
          </div>

          {% if teams %}
            <div class="table-responsive">
              <table class="table align-middle">
                <caption class="visually-hidden">Teams you are a member of</caption>
                <thead class="table-light">
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Sport</th>
                    <th scope="col">Members</th>
                    <th scope="col" class="text-end">Open</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in teams %}
                  <tr>
                    <td>{{ t.name }}</td>
                    <td>{{ t.sport.name }}</td>
                    <td>{{ t.memberships.all|length }}</td>
                    <td class="text-end">
                      <a href="{% url 'players:team_detail' t.id %}" class="btn btn-sm btn-outline-primary">Details</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted small">You’re not in any teams yet. Create one or accept an invite when it appears here.</div>
          {% endif %}
        </div>
      </div>

      <!-- Gallery feed -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h3 class="h5 mb-0">Latest photos</h3>
            <a href="{% url 'players:gallery_list' %}" class="small text-decoration-none">See all</a>
          </div>

          {% if photos %}
            <div class="row g-2">
              {% for p in photos %}
              <div class="col-6 col-md-4">
                <div class="card h-100">
                  <div class="photo-wrap">
                    <img src="{{ p.image.url }}" alt="{{ p.caption|default:'Player photo' }}"
                         loading="lazy"
                         width="800" height="600"
                         onerror="this.onerror=null;this.src='{% static 'images/placeholders/fixture.jpg' %}'">
                  </div>
                  <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-muted">{{ p.uploaded_by.username }}</small>
                      <form method="post" action="{% url 'players:gallery_like' p.id %}">
                        {% csrf_token %}
                        {% if p.id in liked_photos %}
                          <button class="btn btn-sm btn-primary" title="Unlike">
                            <i class="bi bi-hand-thumbs-up-fill me-1" aria-hidden="true"></i>{{ p.like_count }}
                          </button>
                        {% else %}
                          <button class="btn btn-sm btn-outline-primary" title="Like">
                            <i class="bi bi-hand-thumbs-up me-1" aria-hidden="true"></i>{{ p.like_count }}
                          </button>
                        {% endif %}
                      </form>
                    </div>
                    {% if p.caption %}<div class="small mt-1">{{ p.caption }}</div>{% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted small">No photos yet. Be the first to upload your match highlights.</div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Right Column -->
    <aside class="col-lg-2">
      <div class="sticky-col">
        <div class="card shadow-sm text-center">
          <div class="card-body">
            <p class="text-muted mb-2">Upcoming Event</p>
            <img src="{% static 'images/placeholders/fixture.jpg' %}"
                 class="img-fluid rounded mb-2" alt="Upcoming event image"
                 width="400" height="300"
                 loading="lazy">
            <p class="fw-semibold mb-1">Holiday <span class="badge-dot"></span></p>
            <p class="mb-2 text-muted small">Friday 15:00</p>
            <a class="btn btn-outline-primary btn-sm w-100" href="#">
              <i class="bi bi-info-circle me-1" aria-hidden="true"></i>Info
            </a>
          </div>
        </div>
      </div>
    </aside>

  </div>
</main>
{% endblock %}
