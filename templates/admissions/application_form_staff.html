{% extends "backoffice/base.html" %}
{% load static %}

{% block title %}New Sports Quota Application Â· Backoffice{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Sports Quota Application</h2>
  <p class="text-muted">All fields marked * are required. Upload at least one supporting document.</p>

  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Cycle *</label>
        {{ form.cycle }} {{ form.cycle.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">Sport *</label>
        {{ form.sport }} {{ form.sport.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">Level *</label>
        {{ form.level }} {{ form.level.errors }}
      </div>

      <div class="col-md-4">
        <label class="form-label">Playing position</label>
        {{ form.playing_position }} {{ form.playing_position.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">Years experience *</label>
        {{ form.years_experience }} {{ form.years_experience.errors }}
      </div>
    </div>

    <hr class="my-4">

    <h5 class="mb-3">Applicant details</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Full name *</label>
        {{ form.full_name }} {{ form.full_name.errors }}
      </div>
      <div class="col-md-3">
        <label class="form-label">Date of Birth</label>
        {{ form.date_of_birth }} {{ form.date_of_birth.errors }}
      </div>
      <div class="col-md-3">
        <label class="form-label">Profile photo</label>
        {{ form.profile_photo }} {{ form.profile_photo.errors }}
      </div>
      <div class="col-md-6">
        <label class="form-label">Email *</label>
        {{ form.email }} {{ form.email.errors }}
      </div>
      <div class="col-md-6">
        <label class="form-label">Phone *</label>
        {{ form.phone }} {{ form.phone.errors }}
      </div>

      <div class="col-12">
        <label class="form-label">Address line 1 *</label>
        {{ form.address_line1 }} {{ form.address_line1.errors }}
      </div>
      <div class="col-12">
        <label class="form-label">Address line 2</label>
        {{ form.address_line2 }} {{ form.address_line2.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">City *</label>
        {{ form.city }} {{ form.city.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">State</label>
        {{ form.state }} {{ form.state.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">Postal code</label>
        {{ form.postal_code }} {{ form.postal_code.errors }}
      </div>
      <div class="col-md-4">
        <label class="form-label">Country *</label>
        {{ form.country }} {{ form.country.errors }}
      </div>
    </div>

    <hr class="my-4">

    <h5 class="mb-3">Academics & Achievements</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Previous institution</label>
        {{ form.previous_institution }} {{ form.previous_institution.errors }}
      </div>
      <div class="col-md-6">
        <label class="form-label">Academic summary</label>
        {{ form.academic_summary }} {{ form.academic_summary.errors }}
      </div>
      <div class="col-12">
        <label class="form-label">Achievements</label>
        {{ form.achievements }} {{ form.achievements.errors }}
      </div>
    </div>

    <hr class="my-4">

    <h5 class="mb-3">Supporting documents *</h5>
    {{ formset.management_form }}
    <div id="docs-list">
      {% for f in formset.forms %}
        <div class="row g-2 align-items-end mb-2 border rounded p-2">
          <div class="col-md-4">
            <label class="form-label">Document type</label>
            {{ f.doc_type }} {{ f.doc_type.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">File</label>
            {{ f.file }} {{ f.file.errors }}
          </div>
          <div class="col-md-2">
            {% if formset.can_delete %}
              <div class="form-check mt-4">
                {{ f.DELETE }} <label class="form-check-label">Remove</label>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <button type="button" id="add-row" class="btn btn-outline-secondary btn-sm mb-3">
      Add another document
    </button>

    <div class="form-check mt-3">
      {{ form.consent }} <label class="form-check-label"> {{ form.consent.label }}</label>
      {{ form.consent.errors }}
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary">Submit application</button>
      <a href="{% url 'admissions:my_applications' %}" class="btn btn-link">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Tiny vanilla "Add row" for formset
  (function () {
    const addBtn = document.getElementById('add-row');
    if (!addBtn) return;
    addBtn.addEventListener('click', function () {
      const total = document.getElementById('id_applicationdocument_set-TOTAL_FORMS');
      const currentCount = parseInt(total.value, 10);
      const firstRow = document.querySelector('#docs-list .row');
      if (!firstRow) return;
      const clone = firstRow.cloneNode(true);

      clone.querySelectorAll('input, select').forEach(el => {
        if (el.name.endsWith('-DELETE')) {
          el.checked = false;
          return;
        }
        if (el.tagName === 'INPUT') el.value = '';
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        el.name = el.name.replace(`-${currentCount-1}-`, `-${currentCount}-`);
        el.id = el.id.replace(`_${currentCount-1}_`, `_${currentCount}_`).replace(`-${currentCount-1}-`, `-${currentCount}-`);
      });

      clone.querySelectorAll('label').forEach(l => {
        if (l.htmlFor) {
          l.htmlFor = l.htmlFor.replace(`_${currentCount-1}_`, `_${currentCount}_`).replace(`-${currentCount-1}-`, `-${currentCount}-`);
        }
      });

      total.value = currentCount + 1;
      document.getElementById('docs-list').appendChild(clone);
    });
  })();
</script>
{% endblock %}
