{# ---------- SAFE URL RESOLVES (empty if missing) ---------- #}
{% url 'home' as home_url %}
{% url 'contact' as contact_url %}

{# Admissions #}
{% url 'admissions:my_applications' as my_apps_url %}
{% url 'admissions:application_create' as app_create_url %}

{# Accounts #}
{% url 'accounts:profile' as profile_url %}
{% url 'accounts:password_reset' as pwd_reset_url %}
{% url 'accounts:logout' as logout_url %}
{% url 'accounts:login' as login_url %}
{% url 'accounts:register' as register_url %}

{# Players (student) #}
{% url 'players:dashboard' as player_dashboard_url %}
{% url 'players:team_list' as team_list_url %}
{% url 'players:team_create' as team_create_url %}

{# Facilities (public / student) #}
{% url 'facilities:venue_list' as venue_list_url %}
{% url 'facilities:venue_list_student' as venue_list_student_url %}
{% url 'facilities:booking_new' as booking_new_url %}
{% url 'facilities:my_booking_list' as my_bookings_url %}

{# Tournaments (role-specific + public) #}
{% url 'tournaments:tournament_list' as tourn_list_url %}
{% url 'tournaments:admin_list' as tourn_admin_list_url %}
{% url 'tournaments:coach_list' as tourn_coach_list_url %}
{% url 'tournaments:student_list' as tourn_student_list_url %}
{% url 'tournaments:tournament_new' as tourn_new_url %}

<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="{{ home_url }}">
      <span class="fw-semibold">Sports Portal</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" aria-label="Toggle menu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse d-none d-lg-flex justify-content-end align-items-center">
      <ul class="navbar-nav align-items-lg-center">

        <li class="nav-item">
          <a class="nav-link" href="{{ home_url }}">Home</a>
        </li>

        {# Admissions: show only if NOT a student #}
        {% if request.user.is_authenticated and request.user.role == 'student' %}
          {# no admissions for students #}
        {% else %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Admissions</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ my_apps_url }}">My applications</a></li>
              <li><a class="dropdown-item" href="{{ app_create_url }}">New application</a></li>
            </ul>
          </li>
        {% endif %}

        {# Facilities: public list, plus student-only actions when logged in as student #}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Facilities</a>
          <ul class="dropdown-menu">
            {% if request.user.is_authenticated and request.user.role == 'student' and venue_list_student_url %}
              <li><a class="dropdown-item" href="{{ venue_list_student_url }}">Venues</a></li>
            {% else %}
              <li><a class="dropdown-item" href="{{ venue_list_url }}">Venues</a></li>
            {% endif %}
            {% if request.user.is_authenticated and request.user.role == 'student' %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{{ booking_new_url }}">Book a Venue</a></li>
              <li><a class="dropdown-item" href="{{ my_bookings_url }}">My Bookings</a></li>
            {% endif %}
          </ul>
        </li>

        {# Tournaments: role-aware #}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Tournaments</a>
          <ul class="dropdown-menu">
            {# Everyone gets public list #}
            <li><a class="dropdown-item" href="{{ tourn_list_url }}">All Tournaments</a></li>
            <li><hr class="dropdown-divider"></li>

            {# Admin/Staff section (nested ifs to avoid parentheses) #}
            {% if request.user.is_authenticated %}
              {% if request.user.is_staff or request.user.role == 'admin' or request.user.role == 'staff' %}
                {% if tourn_admin_list_url %}
                  <li class="dropdown-header small text-muted">Admin</li>
                  <li><a class="dropdown-item" href="{{ tourn_admin_list_url }}">Admin Tournaments</a></li>
                {% endif %}
                {% if tourn_new_url %}
                  <li><a class="dropdown-item" href="{{ tourn_new_url }}">Create Tournament</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
              {% endif %}
            {% endif %}

            {# Coach section #}
            {% if request.user.is_authenticated %}
              {% if request.user.role == 'coach' %}
                {% if tourn_coach_list_url %}
                  <li class="dropdown-header small text-muted">Coach</li>
                  <li><a class="dropdown-item" href="{{ tourn_coach_list_url }}">Coach Tournaments</a></li>
                {% endif %}
                {% if tourn_new_url %}
                  <li><a class="dropdown-item" href="{{ tourn_new_url }}">Create Tournament</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
              {% endif %}
            {% endif %}

            {# Student quick access (optional) #}
            {% if request.user.is_authenticated and request.user.role == 'student' and tourn_student_list_url %}
              <li class="dropdown-header small text-muted">Student</li>
              <li><a class="dropdown-item" href="{{ tourn_student_list_url }}">My View</a></li>
            {% endif %}
          </ul>
        </li>

        {# Players menu (only for students) #}
        {% if request.user.is_authenticated and request.user.role == 'student' %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Players</a>
            <ul class="dropdown-menu">
              {% if player_dashboard_url %}
                <li><a class="dropdown-item" href="{{ player_dashboard_url }}">Dashboard</a></li>
                <li><hr class="dropdown-divider"></li>
              {% endif %}
              <li><a class="dropdown-item" href="{{ profile_url }}">My Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header small text-muted">Teams</li>
              <li><a class="dropdown-item" href="{{ team_list_url }}">My Teams</a></li>
              <li><a class="dropdown-item" href="{{ team_create_url }}">Create Team</a></li>
            </ul>
          </li>
        {% endif %}

        {# Show Register when logged out #}
        {% if not request.user.is_authenticated and register_url %}
          <li class="nav-item">
            <a class="nav-link" href="{{ register_url }}">Register</a>
          </li>
        {% endif %}

        <li class="nav-item">
          <a class="nav-link" href="{{ contact_url }}">Contact</a>
        </li>

        {# Account controls #}
        <li class="nav-item ms-3">
          {% if request.user.is_authenticated %}
            <div class="btn-group">
              <a class="btn btn-dark" href="{{ profile_url }}">
                <i class="bi bi-person-fill me-1"></i>{{ request.user.get_short_name|default:request.user.username }}
              </a>
              <button class="btn btn-dark dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                {% if request.user.role == 'student' and player_dashboard_url %}
                  <li><a class="dropdown-item" href="{{ player_dashboard_url }}">Player Dashboard</a></li>
                  <li><hr class="dropdown-divider"></li>
                {% endif %}
                <li><a class="dropdown-item" href="{{ profile_url }}">Profile</a></li>
                <li><a class="dropdown-item" href="{{ pwd_reset_url }}">Password reset</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post" action="{{ logout_url }}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-link p-0 text-danger">Logout</button>
                  </form>
                </li>
              </ul>
            </div>
          {% else %}
            <a class="btn btn-primary" href="{{ login_url }}"><i class="bi bi-box-arrow-in-right me-1"></i>Login / Register</a>
          {% endif %}
        </li>
      </ul>
    </div>
  </div>
</nav>

{# ---------- OFFCANVAS (mobile) ---------- #}
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
  <div class="offcanvas-header">
    <a class="d-flex align-items-center gap-2 text-decoration-none" href="{{ home_url }}">
      <span class="fw-semibold text-dark">Sports Portal</span>
    </a>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">
    <ul class="navbar-nav flex-column">
      <li class="nav-item"><a class="nav-link" href="{{ home_url }}">Home</a></li>

      {# Admissions: show only if NOT a student #}
      {% if request.user.is_authenticated and request.user.role == 'student' %}
        {# no admissions for students #}
      {% else %}
        <li class="nav-item mt-3"><span class="text-uppercase small text-muted ps-2">Admissions</span></li>
        <li class="nav-item"><a class="nav-link" href="{{ my_apps_url }}">My applications</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ app_create_url }}">New application</a></li>
      {% endif %}

      <li class="nav-item mt-3"><span class="text-uppercase small text-muted ps-2">Facilities</span></li>
      {% if request.user.is_authenticated and request.user.role == 'student' and venue_list_student_url %}
        <li class="nav-item"><a class="nav-link" href="{{ venue_list_student_url }}">Venues</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ booking_new_url }}">Book a Venue</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ my_bookings_url }}">My Bookings</a></li>
      {% else %}
        <li class="nav-item"><a class="nav-link" href="{{ venue_list_url }}">Venues</a></li>
      {% endif %}

      <li class="nav-item mt-3"><span class="text-uppercase small text-muted ps-2">Tournaments</span></li>
      <li class="nav-item"><a class="nav-link" href="{{ tourn_list_url }}">All Tournaments</a></li>

      {# Admin/Staff (nested) #}
      {% if request.user.is_authenticated %}
        {% if request.user.is_staff or request.user.role == 'admin' or request.user.role == 'staff' %}
          {% if tourn_admin_list_url %}<li class="nav-item"><a class="nav-link" href="{{ tourn_admin_list_url }}">Admin Tournaments</a></li>{% endif %}
          {% if tourn_new_url %}<li class="nav-item"><a class="nav-link" href="{{ tourn_new_url }}">Create Tournament</a></li>{% endif %}
        {% endif %}
      {% endif %}

      {# Coach (nested) #}
      {% if request.user.is_authenticated %}
        {% if request.user.role == 'coach' %}
          {% if tourn_coach_list_url %}<li class="nav-item"><a class="nav-link" href="{{ tourn_coach_list_url }}">Coach Tournaments</a></li>{% endif %}
          {% if tourn_new_url %}<li class="nav-item"><a class="nav-link" href="{{ tourn_new_url }}">Create Tournament</a></li>{% endif %}
        {% endif %}
      {% endif %}

      {% if request.user.is_authenticated and request.user.role == 'student' and tourn_student_list_url %}
        <li class="nav-item"><a class="nav-link" href="{{ tourn_student_list_url }}">My View</a></li>
      {% endif %}

      {% if request.user.is_authenticated %}
        <li class="nav-item mt-3"><span class="text-uppercase small text-muted ps-2">Account</span></li>
        <li class="nav-item"><a class="nav-link" href="{{ profile_url }}">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ pwd_reset_url }}">Password reset</a></li>
        <li class="nav-item">
          <form method="post" action="{{ logout_url }}" class="px-3 py-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger w-100">Logout</button>
          </form>
        </li>
      {% else %}
        <li class="nav-item mt-3"><a class="nav-link" href="{{ register_url }}">Register</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ login_url }}">Login</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ pwd_reset_url }}">Forgot password</a></li>
      {% endif %}

      <li class="nav-item mt-3"><span class="text-uppercase small text-muted ps-2">Contact</span></li>
      <li class="nav-item"><a class="nav-link" href="{{ contact_url }}">Contact</a></li>
    </ul>

    <div class="mt-auto">
      <div class="d-flex gap-3 mb-2">
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-facebook fs-5"></i></a>
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-twitter-x fs-5"></i></a>
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-youtube fs-5"></i></a>
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-instagram fs-5"></i></a>
      </div>
      <p class="small text-muted mb-0">&copy; 2025 Sports Portal</p>
    </div>
  </div>
</div>

<style>
  .navbar .navbar-toggler-icon { background-image: var(--bs-navbar-toggler-icon-bg); }
  .hover-shadow:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.08)!important; }
</style>
