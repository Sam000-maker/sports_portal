{% load static %}

{# ---------- SAFE URL RESOLVES (empty if missing) ---------- #}
{% url 'home' as home_url %}
{% url 'contact' as contact_url %}  {# optional; stays "" if not defined #}

{# Admissions #}
{% url 'admissions:my_applications' as my_apps_url %}
{% url 'admissions:application_create' as app_create_url %}

{# Accounts #}
{% url 'accounts:profile' as profile_url %}
{% url 'accounts:password_reset' as pwd_reset_url %}
{% url 'accounts:logout' as logout_url %}   {# view exists, but we will POST to it #}
{% url 'accounts:login' as login_url %}
{% url 'accounts:register' as register_url %}

{# Admin-facing (staff only) #}
{% url 'accounts:users_list' as users_list_url %}

<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="{{ home_url }}">
      <img src="{% static 'images/football/logo2.png' %}" alt="logo" height="36">
      <span class="fw-semibold">Sports Portal</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" aria-label="Toggle menu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse d-none d-lg-flex justify-content-end align-items-center">
      <ul class="navbar-nav align-items-lg-center">

        <li class="nav-item">
          <a class="nav-link" href="{{ home_url }}">Home</a>
        </li>

        {# Admissions dropdown #}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Admissions</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ my_apps_url }}">My applications</a></li>
            <li><a class="dropdown-item" href="{{ app_create_url }}">New application</a></li>
          </ul>
        </li>

        {# Contact (blank if you haven't wired it) #}
        <li class="nav-item">
          <a class="nav-link" href="{{ contact_url }}">Contact</a>
        </li>

        {# Staff-only Admin menu #}
        {% if request.user.is_staff %}
          <li class="nav-item dropdown ms-2">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Admin</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ users_list_url }}">Users</a></li>
              {# change_user_role requires user_id; keep that in the users page #}
            </ul>
          </li>
        {% endif %}

        {# Account controls #}
        <li class="nav-item ms-3">
          {% if request.user.is_authenticated %}
            <div class="btn-group">
              <a class="btn btn-dark" href="{{ profile_url }}">
                <i class="bi bi-person-fill me-1"></i>{{ request.user.get_short_name|default:request.user.username }}
              </a>
              <button class="btn btn-dark dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ pwd_reset_url }}">Password reset</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post" action="{{ logout_url }}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-link p-0 text-danger">Logout</button>
                  </form>
                </li>
              </ul>
            </div>
          {% else %}
            <a class="btn btn-primary" href="{{ login_url }}"><i class="bi bi-box-arrow-in-right me-1"></i>Login / Register</a>
          {% endif %}
        </li>
      </ul>
    </div>
  </div>
</nav>

{# ---------- OFFCANVAS (mobile + also works on desktop) ---------- #}
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
  <div class="offcanvas-header">
    <a class="d-flex align-items-center gap-2 text-decoration-none" href="{{ home_url }}">
      <img src="{% static 'images/football/logo2.png' %}" alt="logo" height="36">
      <span class="fw-semibold text-dark">Sports Portal</span>
    </a>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">
    <ul class="navbar-nav flex-column">
      <li class="nav-item"><a class="nav-link" href="{{ home_url }}">Home</a></li>

      <li class="nav-item mt-3">
        <span class="text-uppercase small text-muted ps-2">Admissions</span>
      </li>
      <li class="nav-item"><a class="nav-link" href="{{ my_apps_url }}">My applications</a></li>
      <li class="nav-item"><a class="nav-link" href="{{ app_create_url }}">New application</a></li>

      {% if request.user.is_staff %}
        <li class="nav-item mt-3">
          <span class="text-uppercase small text-muted ps-2">Admin</span>
        </li>
        <li class="nav-item"><a class="nav-link" href="{{ users_list_url }}">Users</a></li>
      {% endif %}

      <li class="nav-item mt-3">
        <span class="text-uppercase small text-muted ps-2">Account</span>
      </li>
      {% if request.user.is_authenticated %}
        <li class="nav-item"><a class="nav-link" href="{{ profile_url }}">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ pwd_reset_url }}">Password reset</a></li>
        <li class="nav-item">
          <form method="post" action="{{ logout_url }}" class="px-3 py-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger w-100">Logout</button>
          </form>
        </li>
      {% else %}
        <li class="nav-item"><a class="nav-link" href="{{ login_url }}">Login</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ register_url }}">Register</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ pwd_reset_url }}">Forgot password</a></li>
      {% endif %}

      <li class="nav-item mt-3">
        <span class="text-uppercase small text-muted ps-2">Contact</span>
      </li>
      <li class="nav-item"><a class="nav-link" href="{{ contact_url }}">Contact</a></li>
    </ul>

    <div class="mt-auto">
      <div class="d-flex gap-3 mb-2">
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-facebook fs-5"></i></a>
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-twitter-x fs-5"></i></a>
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-youtube fs-5"></i></a>
        <a class="text-decoration-none text-dark" href=""><i class="bi bi-instagram fs-5"></i></a>
      </div>
      <p class="small text-muted mb-0">
        &copy; 2025 Sports Portal
      </p>
    </div>
  </div>
</div>

<style>
  .navbar .navbar-toggler-icon { background-image: var(--bs-navbar-toggler-icon-bg); }
</style>
